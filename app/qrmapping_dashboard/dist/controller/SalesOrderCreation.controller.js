sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","com/ingenx/qrmappingdashboard/utils/HelperFunction"],function(e,t,s,a,r,n){"use strict";let l="";let o="";let i="";let d="";return e.extend("com.ingenx.qrmappingdashboard.controller.SalesOrderCreation",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.getRoute("onRouteCreateSalesOrder").attachPatternMatched(this._loadSalesOrderType,this)},_loadSalesOrderType:async function(){this._busyDialog=new sap.m.BusyDialog({title:"Processing..."});let e=await n._getSingleEntityData(this,"getDistinctOrderType");let t=new a(e);this.getView().setModel(t,"salesOrderTypeModel")},onCustomerValueHelp:function(){n._openValueHelpDialog(this,"customerValueHelpValueHelp","com.ingenx.qrmappingdashboard.fragments.soCustomer")},onCustomerValueHelpSearch:function(e){n._valueHelpLiveSearch(e,"Kunnr")},onCustomerVendorValueConfirmItem:async function(e){let t=e.getParameter("selectedItem");let s=this.byId("dealerDessc");if(t){let e=t.getTitle();this.getView().byId("salesOrder_dealer").setValue(e);let r=t.getDescription();if(s){s.setVisible(true);s.setValue(r)}else{console.warn("Dealer name field not found")}let n=this.getView().byId("salesOrder_salesOrderType").getValue();if(n&&e){try{let t=await this._getSingleEntityDataWithMulitpleParam(n,e);if(t.length>0){let{DistChannel:e,DistchaText:s}=t[0].DistChannels[0];let{Division:r,DivText:n}=t[0].Divisions[0];let{SalesOrg:l,salesorgText:o}=t[0].SalesOrgs[0];this.setValueInInputFields([{salesOrder_distChannel:e},{salesOrder_distChannelDesc:s},{salesOrder_division:r},{salesOrder_divisionDesc:n},{salesOrder_salesOrg:l},{salesOrder_salesOrgDesc:o}]);let i=new a(t[0].Plants);this.getView().setModel(i,"plantDataModel");this.byId("salesOrder_distChannelDesc").setVisible(true);this.byId("salesOrder_salesOrgDesc").setVisible(true);this.byId("salesOrder_divisionDesc").setVisible(true)}}catch(e){console.error("Error occurred while fetching data:",e)}}else{console.warn("Both Sales Order Type and Dealer must be selected before fetching data.")}}e.getSource().getBinding("items").filter([])},setValueInInputFields:function(e){if(Array.isArray(e)){e.forEach(e=>{let t=Object.keys(e)[0];let s=e[t];let a=this.getView().byId(t);if(a){a.setValue(s)}else{console.warn("Input field with ID",t,"not found")}})}else{console.warn("Invalid input data passed to setValueInInputFields")}},onPlantTypeValueHelp:function(){n._openValueHelpDialog(this,"plantValueHelpValueHelp","com.ingenx.qrmappingdashboard.fragments.soPlant")},onplantValueHelpSearch:function(e){n._valueHelpLiveSearch(e,"Plant")},onplantValueConfirmItem:function(e){let t=e.getParameter("selectedItem");let s=this.byId("plantDesc");if(t){let e=t.getTitle();let a=t.getDescription();this.getView().byId("salesOrder_plant").setValue(e);s?s.setVisible(true)&&s.setValue(a):console.warn("Plant Desc field not Found")}e.getSource().getBinding("items").filter([])},onSalesOrderTypeValueHelp:function(){n._openValueHelpDialog(this,"salesOrgValueHelpValueHelp","com.ingenx.qrmappingdashboard.fragments.soType")},onsalesOrgValueHelpSearch:function(e){n._valueHelpLiveSearch(e,"SalesOrderType")},onSalesOrgValueHelp:function(){n._openValueHelpDialog(this,"onSalesFragment","com.ingenx.qrmappingdashboard.fragments.soSalesOrg")},onDistributionTypeValueHelp:function(){n._openValueHelpDialog(this,"onDistributionFragment","com.ingenx.qrmappingdashboard.fragments.sodistchannel")},ondistchannelValueConfirmItem:function(e){let t=e.getParameter("selectedItem");let s=this.byId("salesOrder_distChannelDesc");if(t){let e=t.getTitle();let a=t.getDescription();this.getView().byId("salesOrder_distChannel").setValue(e);s?s.setVisible(true)&&s.setValue(a):console.warn("Plant Desc field not Found")}e.getSource().getBinding("items").filter([])},onDivisionValueHelp:function(){n._openValueHelpDialog(this,"onDivisionFragment","com.ingenx.qrmappingdashboard.fragments.soDivision")},ondivisionValueConfirmItem:function(e){let t=e.getParameter("selectedItem");let s=this.byId("salesOrder_divisionDesc");if(t){let e=t.getTitle();let a=t.getDescription();this.getView().byId("salesOrder_division").setValue(e);a?s.setVisible(true)&&s.setValue(a):console.log("dist desc not found")}},onsalesOrgValueConfirmItem:function(e){let t=e.getParameter("selectedItem");let s=this.byId("salesOrder_salesOrgDesc");if(t){let e=t.getTitle();let a=t.getDescription();this.byId("salesOrder_salesOrg").setValue(e);a?s.setVisible(true)&&s.setValue(a):console.log("desc not found")}},onsalesTypeValueConfirmItem:function(e){let t=n._valueHelpSelectedValue(e,this,"salesOrder_salesOrderType");let s=this.getView().byId("salesOrder_dealer").getValue();if(t&&s){this._getSingleEntityDataWithMulitpleParam(t,s).then(e=>{if(e.length>0){let{DistChannel:t,DistchaText:s}=e[0].DistChannels[0];let{Division:r,DivText:n}=e[0].Divisions[0];let{SalesOrg:l,salesorgText:o}=e[0].SalesOrgs[0];this.setValueInInputFields([{salesOrder_distChannel:t},{salesOrder_distChannelDesc:s},{salesOrder_division:r},{salesOrder_divisionDesc:n},{salesOrder_salesOrg:l},{salesOrder_salesOrgDesc:o}]);let i=new a(e[0].Plants);this.getView().setModel(i,"plantDataModel");this.byId("salesOrder_distChannelDesc").setVisible(true);this.byId("salesOrder_salesOrgDesc").setVisible(true);this.byId("salesOrder_divisionDesc").setVisible(true)}}).catch(e=>console.error("Error while fetching data:",e))}else{console.warn("Both Sales Order Type and Dealer must be selected.")}},_getSingleEntityDataWithMulitpleParam:async function(e,t){if(e&&t){let s="getSalesOrderTypevalues";let a=this.getOwnerComponent().getModel();let r=a.bindList(`/${s}(SalesOrderType='${e}',Dealer='${t}')`);try{let e=await r.requestContexts(0,Infinity);let t=e.map(e=>e.getObject());if(t.length===0){sap.m.MessageToast.show("Data Not Found");return[]}return t}catch(e){console.error(`Error occurred while reading data from the '${s}' entity:`,e);return[]}}else{console.warn("Sales Order Type and Dealer must be selected.");return[]}},onClickSumbitButton:async function(){try{let e=["salesOrder_salesOrg","salesOrder_salesOrderType","salesOrder_salesOrderDesc","salesOrder_distChannel","salesOrder_division","salesOrder_dealer","salesOrder_plant"];this._busyDialog.open();let t=await n._getInputValues(this,e);let[s,a,r,l,o,c,u]=t;let g={SalesOrderType:a||"",PurchaseOrderByCustomer:r||"",SalesOrganization:s||"",DistributionChannel:l||"",OrganizationDivision:o||"",SoldToParty:c||"",to_Item:[{Material:d,PurchaseOrderByCustomer:r||"",RequestedQuantity:i||"",ProductionPlant:u||"",StorageLocation:""}]};this._sendToBackend(g,e)}catch(e){console.error("Error in onClickSumbitButton:",e);sap.m.MessageToast.show("Failed to submit production order.")}},inputFieldHide:function(e){if(Array.isArray(e)){e.forEach(e=>{let t=this.byId(e);t?t.setVisible(false):console.log(`ID - ${e} not Found`)})}return[]},_sendToBackend:async function(e,t){try{let s=["dealerDessc","salesOrder_distChannelDesc","plantDesc","salesOrder_salesOrgDesc","salesOrder_divisionDesc"];let a=this.getOwnerComponent().getModel();let r=a.bindList("/A_SalesOrder");r.create(e,true);r.attachCreateCompleted(a=>{let r=a.getParameters();if(r.success){let a=r.context.getObject();let l=a.SalesOrder;sap.m.MessageBox.success("Sales Order: "+l,{title:"Sales Order Created",onClose:async()=>{await this._onUpdateOcData(l,e.SoldToParty);n._clearInputValues(this,t);this.inputFieldHide(s);setTimeout(()=>{this._busyDialog.close()},1e3)}})}})}catch(e){console.error("Error in _sendToBackend:",e);sap.m.MessageToast.show("Failed to send data to the backend.")}},_onUpdateOcData:async function(e,t){let s="Sales Order Mapped";let a=this.getOwnerComponent().getModel();let r=a.bindList("/OuterContainer");let n=new sap.ui.model.Filter({path:"OCID",operator:sap.ui.model.FilterOperator.EQ,value1:l});try{let l=await r.filter(n).requestContexts();if(l.length===0){return sap.m.MessageBox.error("No matching entity found")}const i=l[0];i.setProperty("SalesOrder",e);i.setProperty("DealerId",t);i.setProperty("status",s);i.setProperty("DealerName",o);await a.submitBatch("updateGroup")}catch(e){console.log("Error",e)}},onPressBoxQrScanner:async function(e){if(e.getParameter("cancelled")){sap.m.MessageToast.show("Scan cancelled",{duration:1e3});return}const t=e.getParameter("text");if(!t){sap.m.MessageToast.show("No data found in scan",{duration:1e3});return}try{const e=JSON.parse(t);const{SerialNo:s,BatchID:r}=e;if(!s){sap.m.MessageToast.show("Not a valid QR for scan",{duration:1e3});return}const o=this.getOwnerComponent().getModel();const i=o.bindList("/MaterialBox");const d=new sap.ui.model.Filter({path:"SerialNo",operator:sap.ui.model.FilterOperator.EQ,value1:s});const c=await i.filter(d).requestContexts();if(c.length===0){sap.m.MessageBox.error("No matching entity found");return}const u=c[0];const g=await this._getICIdData(l);const p=g.map(e=>e.ICID);console.log("Resolved ICIdData:",p);let h="";if(p.length>1){let e=new a(p);this.getView().setModel(e,"dialogIcListModel");await n._openValueHelpDialog(this,"icListDialog","com.ingenx.qrmappingdashboard.fragments.ICsListValueHelp");h=await this.onICCodeSelection()}else{h=p[0]}if(h){u.setProperty("IC_ICID",h);u.setProperty("BatchID",r);await o.submitBatch("updateGroup");await this._loadContainerTableData();setTimeout(()=>{sap.m.MessageToast.show("Data updated successfully!")},0)}else{console.log("Ic code is not selected")}}catch(e){console.error("Error processing scan:",e);sap.m.MessageBox.error("An error occurred: "+(e.message||"Unknown error"))}},onICCodeSelection:function(){return new Promise((e,t)=>{const s=this.byId("icListDialog");if(!s){t(new Error("Dialog not found"));return}s.attachConfirm(s=>{const a=s.getParameter("selectedItem");if(a){const t=a.getTitle();e(t)}else{t(new Error("No item selected"))}})})},_getICIdData:async function(e){let t=await n._getSingleEntityData(this,"InnerContainer");if(e){try{let s=t.filter(t=>t.OC_OCID===e);return s}catch(e){console.log("Error",e)}}},onPressIcQrScanner:async function(e){try{if(e.getParameter("cancelled")){sap.m.MessageToast.show("Scan cancelled",{duration:1e3});return}let t=e.getParameter("text");if(!t){sap.m.MessageToast.show("No data found in scan",{duration:1e3});return}let s=JSON.parse(t);let a=s.ICID;if(!a){sap.m.MessageToast.show("Invalid scan data. ICID not found.",{duration:1e3});return}let r=this.getOwnerComponent().getModel();let n=r.bindList("/OuterContainer");let o=new sap.ui.model.Filter({path:"OCID",operator:sap.ui.model.FilterOperator.EQ,value1:l});n.filter([o]);n.requestContexts().then(async e=>{if(!e.length){sap.m.MessageBox.error("No matching OuterContainer found for the given Sales Order.");return}let t=e[0];let s=t.getObject();let n=s.OCQRCode;let o=s.OCQRCodeURL;let i=r.bindList("/InnerContainer");let d=new sap.ui.model.Filter({path:"ICID",operator:sap.ui.model.FilterOperator.EQ,value1:a});i.filter(d).requestContexts().then(e=>{if(e.length===0){sap.m.MessageBox.error("No matching entity found for the given filter.");return}let t=e[0];t.setProperty("OC_OCID",l);t.setProperty("OC_OCQRCode",n);t.setProperty("OC_OCQRCodeURL",o);t.setProperty("SalesOrder","");r.submitBatch("updateGroup").then(async()=>{await this._loadContainerTableData();setTimeout(()=>{sap.m.MessageToast.show("Data updated successfully!")},0)},e=>{console.error("Error updating data:",e);sap.m.MessageBox.error("Error occurred: "+(e.message||"Unknown error."))})}).catch(e=>{console.error("Error requesting contexts:",e);sap.m.MessageBox.error("Failed to retrieve data: "+e.message)})}).catch(e=>{console.error("Error requesting contexts:",e);sap.m.MessageBox.error("Failed to retrieve data: "+e.message)})}catch(e){console.error("Error in onScanSuccess:",e);sap.m.MessageBox.error(e.message)}},onPressOcQrScanner:async function(e){this._displayTable=this.byId("salesOrderCreate_Table");if(e.getParameter("cancelled")){sap.m.MessageToast.show("Scan cancelled",{duration:1e3})}else{let t=e.getParameter("text");if(t){let e=JSON.parse(t);let{OCID:s}=e;l=s;this._displayTable.setBusy(true);await this._loadContainerTableData()}else{sap.m.MessageToast.show("No data found in scan",{duration:1e3})}}},_loadContainerTableData:async function(){if(l){let e=this.getOwnerComponent().getModel();let t=e.bindList(`/getScannedOCData(OCID='${l}')`);try{let e=await t.requestContexts(0,Infinity);let s=e.map(e=>e.getObject());let r=s[0];let n=r.OCID;let l=r.ProductionOrder||"";let o=r.ManufactureDt||"";let c=r.ExpiryDt||"";let u=r.BatchID||"";let g=r.Material||"";d=g;let p=[];if(r.ICs&&r.ICs.length>0){p=r.ICs.flatMap(e=>{if(e.Boxes&&e.Boxes.length>0){return e.Boxes.map(t=>({ICID:e.ICID,ICQRCode:e.ICQRCode,BoxSerialNo:t.SerialNo,BoxQRCode:t.BoxQRCode,pOrder:l,mfgDate:o,expDate:c,BatchID:u,lMaterial:g,ocId:n}))}else{return{ICID:e.ICID,ICQRCode:e.ICQRCode,ocId:n}}})}else{p.push({ocId:n})}let h=p.map(e=>e.BoxSerialNo);i=h.length;let m=new a(p);this.getView().setModel(m,"salesOrderModelData");this._displayTable.setBusy(false)}catch(e){console.log(e)}}}})});
//# sourceMappingURL=SalesOrderCreation.controller.js.map